console.log('NEW APP.JS LOADED!');
var RENDER_URL = 'wss://discord-clone-ws.onrender.com';
var WS_URL = (window.location.protocol === 'file:' || window.location.hostname === 'localhost' || window.location.hostname === '') ? RENDER_URL : 'wss://' + window.location.hostname;
console.log('WS_URL:', WS_URL);
var state = {ws:null,userId:null,username:null,userAvatar:null,servers:new Map(),friends:new Map(),pendingRequests:[],currentServer:null,currentChannel:null,currentDM:null,voiceChannel:null,voiceUsers:new Map(),localStream:null,peerConnections:new Map(),newServerIcon:null,editingServerId:null,editServerIcon:null,creatingVoice:false,micTestStream:null,micTestAudio:null,micTestAnalyser:null,micTestAnimFrame:null,deletingChannelId:null,deletingChannelIsVoice:false,editingChannelId:null,editingChannelIsVoice:false,replyingTo:null,forwardingMsg:null};
function qS(s){return document.querySelector(s);}
function qSA(s){return document.querySelectorAll(s);}
function escapeHtml(t){var d=document.createElement('div');d.textContent=t;return d.innerHTML;}
function displayStatus(s){return{online:'В сети',idle:'Не активен',dnd:'Не беспокоить',invisible:'Невидимый',offline:'Не в сети'}[s]||'В сети';}
function send(d){if(state.ws&&state.ws.readyState===1){state.ws.send(JSON.stringify(d));return true;}return false;}
function connect(){console.log('Connecting to', WS_URL);showConnecting();state.ws=new WebSocket(WS_URL);state.ws.onopen=function(){console.log('Connected');hideConnecting();setTimeout(tryAutoLogin,100);startPing();};state.ws.onclose=function(){console.log('Disconnected');stopPing();setTimeout(connect,3000);};state.ws.onerror=function(e){console.error('WS error',e);};state.ws.onmessage=function(e){handleMessage(JSON.parse(e.data));};}
function tryAutoLogin(){var email=localStorage.getItem('lastEmail');var pwd=localStorage.getItem('lastPwd');console.log('tryAutoLogin',email?'has email':'no email');if(email&&pwd){send({type:'login',email:email,password:pwd});}}
var pingInterval=null;
function startPing(){stopPing();pingInterval=setInterval(function(){if(state.ws&&state.ws.readyState===1){state.ws.send(JSON.stringify({type:'ping'}));}},25000);}
function stopPing(){if(pingInterval){clearInterval(pingInterval);pingInterval=null;}}
function showConnecting(){var el=qS('#connecting-overlay');if(!el){el=document.createElement('div');el.id='connecting-overlay';el.innerHTML='<div class="connecting-box"><div class="connecting-spinner"></div><div class="connecting-text">Подключение к серверу...</div><div class="connecting-hint">Первое подключение может занять до 30 секунд</div></div>';document.body.appendChild(el);}el.classList.add('visible');}
function hideConnecting(){var el=qS('#connecting-overlay');if(el)el.classList.remove('visible');}function showView(id){qSA('.main-view').forEach(function(v){v.classList.remove('active');});var el=document.getElementById(id);if(el)el.classList.add('active');}
function openModal(id){var el=document.getElementById(id);if(el)el.classList.add('active');}
function closeModal(id){var el=document.getElementById(id);if(el)el.classList.remove('active');}
function hideContextMenu(){qSA('.context-menu').forEach(function(m){m.classList.remove('visible');});}

function handleMessage(msg){console.log('MSG:',msg.type);if(msg.type==='auth_success'){state.userId=msg.userId;state.username=msg.user?msg.user.name:'User';state.userAvatar=msg.user?msg.user.avatar:null;localStorage.setItem('session',JSON.stringify({email:msg.email||localStorage.getItem('lastEmail'),userId:msg.userId}));var auth=qS('#auth-screen');var main=qS('#main-app');if(auth)auth.classList.remove('active');if(main)main.classList.remove('hidden');if(msg.servers){var keys=Object.keys(msg.servers);for(var i=0;i<keys.length;i++){state.servers.set(msg.servers[keys[i]].id,msg.servers[keys[i]]);}}if(msg.friends){for(var j=0;j<msg.friends.length;j++){state.friends.set(msg.friends[j].id,msg.friends[j]);}}if(msg.pendingRequests)state.pendingRequests=msg.pendingRequests;updateUserPanel();renderServers();renderFriends();loadAudioDevices();}else if(msg.type==='auth_error'){localStorage.removeItem('session');var err=msg.message||'Ошибка';var le=qS('#login-error');var lb=qS('#login-box');if(le&&lb&&!lb.classList.contains('hidden'))le.textContent=err;var re=qS('#reg-error');if(re&&lb&&lb.classList.contains('hidden'))re.textContent=err;}else if(msg.type==='friend_request_sent'){showNotification('Заявка в друзья отправлена');}else if(msg.type==='friend_error'){showNotification(msg.message||'Пользователь не найден');}else if(msg.type==='server_created'||msg.type==='server_joined'){state.servers.set(msg.server.id,msg.server);renderServers();}else if(msg.type==='server_updated'){var srv=state.servers.get(msg.serverId);if(srv){if(msg.name)srv.name=msg.name;if(msg.icon!==undefined)srv.icon=msg.icon;renderServers();if(state.currentServer===msg.serverId)renderChannels();}}else if(msg.type==='server_deleted'||msg.type==='server_left'){state.servers.delete(msg.serverId);if(state.currentServer===msg.serverId){state.currentServer=null;state.currentChannel=null;showView('friends-view');}renderServers();}else if(msg.type==='channel_created'){var s=state.servers.get(msg.serverId);if(s){if(msg.isVoice){s.voiceChannels=s.voiceChannels||[];s.voiceChannels.push(msg.channel);}else{s.channels=s.channels||[];s.channels.push(msg.channel);s.messages=s.messages||{};s.messages[msg.channel.id]=[];}if(state.currentServer===msg.serverId)renderChannels();}}else if(msg.type==='channel_deleted'){console.log('Channel deleted:',msg);var sd=state.servers.get(msg.serverId);if(sd){if(msg.isVoice){sd.voiceChannels=sd.voiceChannels.filter(function(ch){return ch.id!==msg.channelId;});}else{sd.channels=sd.channels.filter(function(ch){return ch.id!==msg.channelId;});delete sd.messages[msg.channelId];if(state.currentChannel===msg.channelId){state.currentChannel=null;if(sd.channels&&sd.channels[0])openChannel(sd.channels[0].id);}}if(state.currentServer===msg.serverId)renderChannels();}}else if(msg.type==='channel_updated'){var su=state.servers.get(msg.serverId);if(su){var chs=msg.isVoice?su.voiceChannels:su.channels;for(var ci=0;ci<chs.length;ci++){if(chs[ci].id===msg.channelId){if(msg.name)chs[ci].name=msg.name;if(msg.topic!==undefined)chs[ci].topic=msg.topic;break;}}if(state.currentServer===msg.serverId)renderChannels();}}else if(msg.type==='message_deleted'){console.log('Message deleted received:',msg);var smd=state.servers.get(msg.serverId);if(smd&&smd.messages&&smd.messages[msg.channelId]){smd.messages[msg.channelId]=smd.messages[msg.channelId].filter(function(m){return m.id!=msg.messageId;});smd.messages[msg.channelId].forEach(function(m){if(m.replyTo&&m.replyTo.id==msg.messageId){m.replyTo.deleted=true;}});if(state.currentServer===msg.serverId&&state.currentChannel===msg.channelId){renderMessages(smd.messages[msg.channelId]);}}}else if(msg.type==='message'){if(msg.channel&&msg.serverId){var ms=state.servers.get(msg.serverId);if(ms){ms.messages=ms.messages||{};ms.messages[msg.channel]=ms.messages[msg.channel]||[];ms.messages[msg.channel].push(msg.message);}if(state.currentChannel===msg.channel){if(msg.message.oderId===state.userId){var temps=qSA('.message.pending');for(var ti=0;ti<temps.length;ti++){temps[ti].remove();}}appendMessage(msg.message);}}}else if(msg.type==='dm'){if(state.currentDM===msg.message.from)appendMessage(msg.message,true);}else if(msg.type==='friend_request_incoming'){state.pendingRequests.push(msg.user);renderFriends();}else if(msg.type==='friend_added'){state.friends.set(msg.user.id,msg.user);state.pendingRequests=state.pendingRequests.filter(function(r){return r.id!==msg.user.id;});renderFriends();}else if(msg.type==='friends_list'){state.friends.clear();for(var k=0;k<msg.friends.length;k++){state.friends.set(msg.friends[k].id,msg.friends[k]);}state.pendingRequests=msg.requests||[];renderFriends();}else if(msg.type==='invite_created'){var ic=qS('#invite-code-display');if(ic)ic.value=msg.code;openModal('invite-modal');}else if(msg.type==='profile_updated'){state.username=msg.user.name;state.userAvatar=msg.user.avatar;updateUserPanel();updateMessagesForUser(state.userId,msg.user.name,msg.user.avatar);if(state.currentServer)send({type:'get_server_members',serverId:state.currentServer});}else if(msg.type==='server_members'){var srvM=state.servers.get(msg.serverId);if(srvM)srvM.membersData=msg.members;renderServerMembers(msg.members,msg.serverId);if(state.currentServer===msg.serverId)renderMembers();}else if(msg.type==='user_update'||msg.type==='user_join'){if(msg.user){state.friends.set(msg.user.id,msg.user);updateMessagesForUser(msg.user.id,msg.user.name,msg.user.avatar);renderFriends();if(state.currentServer){send({type:'get_server_members',serverId:state.currentServer});}}}else if(msg.type==='user_leave'){if(msg.oderId){var f=state.friends.get(msg.oderId);if(f){f.status='offline';renderFriends();if(state.currentServer){send({type:'get_server_members',serverId:state.currentServer});}}}}else if(msg.type==='member_joined'){var srvJ=state.servers.get(msg.serverId);if(srvJ&&msg.user){if(!srvJ.members.includes(msg.user.id))srvJ.members.push(msg.user.id);state.friends.set(msg.user.id,msg.user);if(state.currentServer===msg.serverId){send({type:'get_server_members',serverId:msg.serverId});}}}else if(msg.type==='member_left'){var srvL=state.servers.get(msg.serverId);if(srvL){srvL.members=srvL.members.filter(function(m){return m!==msg.oderId;});if(state.currentServer===msg.serverId){send({type:'get_server_members',serverId:msg.serverId});}}}else if(msg.type==='error'){alert(msg.message||'Ошибка');}}
function showNotification(text){var n=document.createElement('div');n.className='notification';n.textContent=text;document.body.appendChild(n);setTimeout(function(){n.classList.add('show');},10);setTimeout(function(){n.classList.remove('show');setTimeout(function(){n.remove();},300);},3000);}
function updateMessagesForUser(oderId,newName,newAvatar){var msgs=qSA('.message[data-author-id="'+oderId+'"]');for(var i=0;i<msgs.length;i++){var m=msgs[i];var authorEl=m.querySelector('.author');var avatarEl=m.querySelector('.message-body > .avatar');if(authorEl)authorEl.textContent=newName;if(avatarEl){if(newAvatar)avatarEl.innerHTML='<img src="'+newAvatar+'">';else{avatarEl.innerHTML='';avatarEl.textContent=newName.charAt(0).toUpperCase();}}m.dataset.author=newName;}}
function updateUserPanel(){var av=qS('#user-avatar');var nm=qS('#user-name');if(av){if(state.userAvatar)av.innerHTML='<img src="'+state.userAvatar+'">';else{av.innerHTML='';av.textContent=state.username?state.username.charAt(0).toUpperCase():'?';}}if(nm)nm.textContent=state.username||'Гость';}
function renderServers(){var c=qS('#servers-list');if(!c)return;var old=c.querySelectorAll('.server-btn:not(.home-btn):not(.add-server):not(.join-server)');for(var i=0;i<old.length;i++)old[i].remove();var add=c.querySelector('.add-server');state.servers.forEach(function(srv){var b=document.createElement('div');b.className='server-btn';b.dataset.id=srv.id;b.title=srv.name;if(srv.icon){b.classList.add('has-icon');b.innerHTML='<img src="'+srv.icon+'">';}else{b.textContent=srv.name.charAt(0).toUpperCase();}b.onclick=function(){openServer(srv.id);};b.oncontextmenu=function(e){e.preventDefault();showServerContext(e.clientX,e.clientY,srv);};c.insertBefore(b,add);});}
function showServerContext(x,y,srv){var ctx=qS('#server-context');if(!ctx)return;ctx.style.left=x+'px';ctx.style.top=y+'px';ctx.classList.add('visible');ctx.dataset.serverId=srv.id;}

function showChannelContext(x,y,channelId,isVoice){var ctx=qS('#channel-context');if(!ctx)return;ctx.style.left=x+'px';ctx.style.top=y+'px';ctx.classList.add('visible');ctx.dataset.channelId=channelId;ctx.dataset.isVoice=isVoice?'1':'0';}

function showCategoryContext(x,y,isVoice){var ctx=qS('#category-context');if(!ctx)return;ctx.style.left=x+'px';ctx.style.top=y+'px';ctx.classList.add('visible');ctx.dataset.isVoice=isVoice?'1':'0';}

function showMessageContext(x,y,msgId,msgText,isOwn,msgAuthor){var ctx=qS('#message-context');if(!ctx)return;ctx.style.left=x+'px';ctx.style.top=y+'px';ctx.classList.add('visible');ctx.dataset.msgId=msgId;ctx.dataset.msgText=msgText;ctx.dataset.msgAuthor=msgAuthor||'';ctx.dataset.isOwn=isOwn?'1':'0';var delBtn=ctx.querySelector('[data-action="delete-message"]');if(delBtn)delBtn.style.display=isOwn?'flex':'none';}

function showReplyBar(){var bar=qS('#reply-bar');if(!bar||!state.replyingTo)return;var rn=bar.querySelector('.reply-name');var rt=bar.querySelector('.reply-text');if(rn)rn.textContent=state.replyingTo.author;if(rt)rt.textContent=state.replyingTo.text.substring(0,50)+(state.replyingTo.text.length>50?'...':'');bar.classList.add('visible');var inp=qS('#msg-input');if(inp)inp.focus();}

function hideReplyBar(){var bar=qS('#reply-bar');if(bar)bar.classList.remove('visible');state.replyingTo=null;}

function renderChannels(){var srv=state.servers.get(state.currentServer);if(!srv)return;var tl=qS('#channel-list');var vl=qS('#voice-list');if(!tl||!vl)return;var th='';var chs=srv.channels||[];for(var i=0;i<chs.length;i++){var c=chs[i];th+='<div class="channel-item'+(state.currentChannel===c.id?' active':'')+'" data-id="'+c.id+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 9h16M4 15h16M10 3L8 21M16 3l-2 18"/></svg><span>'+escapeHtml(c.name)+'</span></div>';}tl.innerHTML=th;var vh='';var vcs=srv.voiceChannels||[];for(var j=0;j<vcs.length;j++){var vc=vcs[j];vh+='<div class="voice-item'+(state.voiceChannel===vc.id?' connected':'')+'" data-id="'+vc.id+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg><span>'+escapeHtml(vc.name)+'</span></div>';}vl.innerHTML=vh;var items=tl.querySelectorAll('.channel-item');for(var k=0;k<items.length;k++){(function(el){el.onclick=function(){openChannel(el.dataset.id);};el.oncontextmenu=function(e){e.preventDefault();showChannelContext(e.clientX,e.clientY,el.dataset.id,false);};})(items[k]);}var vitems=vl.querySelectorAll('.voice-item');for(var m=0;m<vitems.length;m++){(function(el){el.onclick=function(){joinVoiceChannel(el.dataset.id);};el.oncontextmenu=function(e){e.preventDefault();showChannelContext(e.clientX,e.clientY,el.dataset.id,true);};})(vitems[m]);}renderMembers();}
function renderMembers(){var srv=state.servers.get(state.currentServer);var ol=qS('#members-online');var ofl=qS('#members-offline');if(!srv||!ol||!ofl)return;var mems=srv.membersData||[];var on=[],off=[];for(var i=0;i<mems.length;i++){var m=mems[i];if(m.status==='online')on.push(m);else off.push(m);}var oc=qS('#online-count');var ofc=qS('#offline-count');if(oc)oc.textContent=on.length;if(ofc)ofc.textContent=off.length;var oh='',ofh='';for(var j=0;j<on.length;j++)oh+=memberHTMLData(on[j],srv);for(var k=0;k<off.length;k++)ofh+=memberHTMLData(off[k],srv);ol.innerHTML=oh;ofl.innerHTML=ofh;}
function memberHTMLData(m,srv){var isOwner=srv&&srv.ownerId===m.id;var crownSvg='<svg class="crown-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>';return'<div class="member-item" data-id="'+m.id+'"><div class="avatar '+(m.status||'offline')+'">'+(m.avatar?'<img src="'+m.avatar+'">':m.name.charAt(0).toUpperCase())+'</div><span>'+escapeHtml(m.name)+(isOwner?' '+crownSvg:'')+'</span></div>';}
function renderFriends(){var all=[];state.friends.forEach(function(f){all.push(f);});var online=all.filter(function(f){return f.status==='online';});var ol=qS('#online-users');var al=qS('#all-users');var pl=qS('#pending-users');var pc=qS('#pending-count');if(ol)ol.innerHTML=online.length?online.map(userItemHTML).join(''):'<div class="empty">Нет друзей в сети</div>';if(al)al.innerHTML=all.length?all.map(userItemHTML).join(''):'<div class="empty">Нет друзей</div>';if(pl){pl.innerHTML=state.pendingRequests.length?state.pendingRequests.map(pendingItemHTML).join(''):'<div class="empty">Нет запросов</div>';var abs=pl.querySelectorAll('.accept-btn');for(var i=0;i<abs.length;i++){(function(b){b.onclick=function(){send({type:'friend_accept',from:b.dataset.id});};})(abs[i]);}var rbs=pl.querySelectorAll('.reject-btn');for(var j=0;j<rbs.length;j++){(function(b){b.onclick=function(){send({type:'friend_reject',from:b.dataset.id});};})(rbs[j]);}}if(pc)pc.textContent=state.pendingRequests.length||'';var mbs=qSA('.msg-btn');for(var k=0;k<mbs.length;k++){(function(b){b.onclick=function(){openDM(b.dataset.id);};})(mbs[k]);}}
function userItemHTML(u){return'<div class="user-item" data-id="'+u.id+'"><div class="avatar '+(u.status||'offline')+'">'+(u.avatar?'<img src="'+u.avatar+'">':(u.name?u.name.charAt(0).toUpperCase():'?'))+'</div><div class="info"><div class="name">'+escapeHtml(u.name||'User')+'</div><div class="status">'+displayStatus(u.status)+'</div></div><div class="actions"><button class="msg-btn" data-id="'+u.id+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></button></div></div>';}
function pendingItemHTML(u){return'<div class="user-item" data-id="'+u.id+'"><div class="avatar">'+(u.name?u.name.charAt(0).toUpperCase():'?')+'</div><div class="info"><div class="name">'+escapeHtml(u.name||'User')+'</div><div class="status">Хочет добавить вас</div></div><div class="actions"><button class="accept-btn" data-id="'+u.id+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></button><button class="reject-btn" data-id="'+u.id+'"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div></div>';}

function renderMessages(msgs){var c=qS('#messages');if(!c)return;c.innerHTML=(msgs||[]).map(messageHTML).join('');c.scrollTop=c.scrollHeight;}
function messageHTML(m){var t=typeof m.time==='number'?new Date(m.time).toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}):(m.time||new Date().toLocaleTimeString('ru-RU',{hour:'2-digit',minute:'2-digit'}));var a=m.author||m.username||'User';var isOwn=m.oderId===state.userId;var txt=m.text||m.content||'';var pendingClass=m.pending?' pending':'';var replyHtml='';if(m.replyTo){var ra=m.replyTo.author||'?';var rav=m.replyTo.avatar;var isDeleted=m.replyTo.deleted;if(isDeleted){replyHtml='<div class="message-reply deleted"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg><span class="reply-content">Сообщение удалено</span></div>';}else{replyHtml='<div class="message-reply" data-reply-id="'+m.replyTo.id+'"><div class="reply-avatar">'+(rav?'<img src="'+rav+'">':ra.charAt(0).toUpperCase())+'</div><span class="reply-author">'+escapeHtml(ra)+'</span><span class="reply-content">'+escapeHtml(m.replyTo.text||'').substring(0,50)+'</span></div>';}}return'<div class="message'+(m.replyTo?' has-reply':'')+pendingClass+'" data-id="'+m.id+'" data-author-id="'+(m.oderId||'')+'" data-author="'+escapeHtml(a)+'" data-text="'+escapeHtml(txt)+'">'+replyHtml+'<div class="message-body"><div class="avatar">'+(m.avatar?'<img src="'+m.avatar+'">':a.charAt(0).toUpperCase())+'</div><div class="content"><div class="header"><span class="author">'+escapeHtml(a)+'</span><span class="time">'+t+'</span></div><div class="text">'+escapeHtml(txt)+'</div></div></div></div>';}
function renderMessages(msgs){var c=qS('#messages');if(!c)return;c.innerHTML=(msgs||[]).map(messageHTML).join('');c.scrollTop=c.scrollHeight;bindMessageContextMenu();bindReplyClicks();}
function bindMessageContextMenu(){var msgs=qSA('#messages .message');for(var i=0;i<msgs.length;i++){(function(el){el.oncontextmenu=function(e){e.preventDefault();var isOwn=el.dataset.authorId===state.userId;showMessageContext(e.clientX,e.clientY,el.dataset.id,el.dataset.text,isOwn,el.dataset.author);};})(msgs[i]);}}
function bindReplyClicks(){var replies=qSA('#messages .message-reply');for(var i=0;i<replies.length;i++){(function(el){el.onclick=function(e){e.stopPropagation();var replyId=el.dataset.replyId;if(!replyId)return;var targetMsg=qS('.message[data-id="'+replyId+'"]');if(targetMsg){targetMsg.scrollIntoView({behavior:'smooth',block:'center'});targetMsg.classList.add('highlighted');setTimeout(function(){targetMsg.classList.remove('highlighted');},2000);}};})(replies[i]);}}
function appendMessage(m,isDM){var c=isDM?qS('#dm-messages'):qS('#messages');if(!c)return;c.insertAdjacentHTML('beforeend',messageHTML(m));c.scrollTop=c.scrollHeight;bindMessageContextMenu();bindReplyClicks();}
function openServer(id){state.currentServer=id;state.currentDM=null;var srv=state.servers.get(id);var sn=qS('#server-name');if(sn)sn.textContent=srv?srv.name:'Сервер';var btns=qSA('.server-btn');for(var i=0;i<btns.length;i++)btns[i].classList.toggle('active',btns[i].dataset.id===id);var svs=qSA('.sidebar-view');for(var j=0;j<svs.length;j++)svs[j].classList.remove('active');var sv=qS('#server-view');var mp=qS('#members-panel');if(sv)sv.classList.add('active');if(mp)mp.classList.add('visible');renderChannels();send({type:'get_server_members',serverId:id});if(srv&&srv.channels&&srv.channels[0])openChannel(srv.channels[0].id);}
function openChannel(id){state.currentChannel=id;var srv=state.servers.get(state.currentServer);var ch=null;if(srv&&srv.channels){for(var i=0;i<srv.channels.length;i++){if(srv.channels[i].id===id){ch=srv.channels[i];break;}}}var cn=qS('#channel-name');var mi=qS('#msg-input');if(cn)cn.textContent=ch?ch.name:'Канал';if(mi)mi.placeholder='Написать в #'+(ch?ch.name:'канал');renderChannels();showView('chat-view');var msgs=srv&&srv.messages?srv.messages[id]:[];renderMessages(msgs||[]);}
function openDM(uid){state.currentDM=uid;state.currentChannel=null;state.currentServer=null;var f=state.friends.get(uid);var n=f?f.name:'User';var dhn=qS('#dm-header-name');var dha=qS('#dm-header-avatar');var dn=qS('#dm-name');var da=qS('#dm-avatar');var di=qS('#dm-input');if(dhn)dhn.textContent=n;if(dha)dha.textContent=n.charAt(0).toUpperCase();if(dn)dn.textContent=n;if(da)da.textContent=n.charAt(0).toUpperCase();if(di)di.placeholder='Написать @'+n;var btns=qSA('.server-btn');for(var i=0;i<btns.length;i++)btns[i].classList.remove('active');var hb=qS('.home-btn');if(hb)hb.classList.add('active');var svs=qSA('.sidebar-view');for(var j=0;j<svs.length;j++)svs[j].classList.remove('active');var hv=qS('#home-view');var mp=qS('#members-panel');if(hv)hv.classList.add('active');if(mp)mp.classList.remove('visible');showView('dm-view');var dm=qS('#dm-messages');if(dm)dm.innerHTML='';}
function joinVoiceChannel(id){if(state.voiceChannel===id){leaveVoiceChannel();return;}if(state.voiceChannel)leaveVoiceChannel();state.voiceChannel=id;send({type:'voice_join',channelId:id,serverId:state.currentServer});startVoice();renderChannels();var srv=state.servers.get(state.currentServer);var ch=null;if(srv&&srv.voiceChannels){for(var i=0;i<srv.voiceChannels.length;i++){if(srv.voiceChannels[i].id===id){ch=srv.voiceChannels[i];break;}}}var vn=qS('#voice-name');if(vn)vn.textContent=ch?ch.name:'Голосовой';showView('voice-view');}
function leaveVoiceChannel(){send({type:'voice_leave',channelId:state.voiceChannel});stopVoice();state.voiceChannel=null;state.voiceUsers.clear();renderChannels();showView('chat-view');}
function startVoice(){navigator.mediaDevices.getUserMedia({audio:true}).then(function(s){state.localStream=s;}).catch(function(e){console.error('Mic error',e);});}
function stopVoice(){if(state.localStream){var tracks=state.localStream.getTracks();for(var i=0;i<tracks.length;i++)tracks[i].stop();state.localStream=null;}state.peerConnections.forEach(function(pc){pc.close();});state.peerConnections.clear();}

function renderServerMembers(mems,sid){var c=qS('#server-members-list');if(!c)return;var srv=state.servers.get(sid);var isOwner=srv&&srv.ownerId===state.userId;var crownSvg='<svg class="crown-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .6-.4 1-1 1H6c-.6 0-1-.4-1-1v-1h14v1z"/></svg>';var h='';for(var i=0;i<mems.length;i++){var m=mems[i];h+='<div class="member-row'+(m.isOwner?' owner':'')+'" data-id="'+m.id+'"><div class="avatar">'+(m.avatar?'<img src="'+m.avatar+'">':(m.name?m.name.charAt(0).toUpperCase():'?'))+'</div><div class="member-info"><div class="member-name">'+escapeHtml(m.name||'User')+(m.isOwner?' '+crownSvg:'')+'</div><div class="member-role">'+(m.isOwner?'Владелец':'Участник')+'</div></div>'+(isOwner&&!m.isOwner?'<div class="member-actions"><button class="kick-btn" data-id="'+m.id+'">Исключить</button></div>':'')+'</div>';}c.innerHTML=h;var kbs=c.querySelectorAll('.kick-btn');for(var j=0;j<kbs.length;j++){(function(b,members){b.onclick=function(){var mem=null;for(var k=0;k<members.length;k++){if(members[k].id===b.dataset.id){mem=members[k];break;}}if(confirm('Исключить '+(mem?mem.name:'')+'?')){send({type:'kick_member',serverId:state.editingServerId,memberId:b.dataset.id});}};})(kbs[j],mems);}}
function applyTheme(t){document.body.className='theme-'+t;var tbs=qSA('.theme-btn');for(var i=0;i<tbs.length;i++)tbs[i].classList.toggle('active',tbs[i].dataset.theme===t);}
function loadAudioDevices(){navigator.mediaDevices.enumerateDevices().then(function(devs){var mics=devs.filter(function(d){return d.kind==='audioinput';});var spks=devs.filter(function(d){return d.kind==='audiooutput';});var mo=qS('#mic-select-options');var mt=qS('#mic-select-trigger span');if(mo&&mics.length){var mh='';for(var i=0;i<mics.length;i++){mh+='<div class="custom-select-option'+(i===0?' selected':'')+'" data-value="'+mics[i].deviceId+'">'+(mics[i].label||'Микрофон '+(i+1))+'</div>';}mo.innerHTML=mh;if(mt)mt.textContent=mics[0].label||'Микрофон 1';}var so=qS('#speaker-select-options');var st=qS('#speaker-select-trigger span');if(so&&spks.length){var sh='';for(var j=0;j<spks.length;j++){sh+='<div class="custom-select-option'+(j===0?' selected':'')+'" data-value="'+spks[j].deviceId+'">'+(spks[j].label||'Динамик '+(j+1))+'</div>';}so.innerHTML=sh;if(st)st.textContent=spks[0].label||'Динамик 1';}}).catch(function(e){console.error('Audio err',e);});}

function startMicTest(){
var btn=qS('#mic-test-btn');
var bar=qS('#mic-level-bar');
var micSelect=qS('#mic-select');
var deviceId=micSelect?micSelect.value:'';
var constraints={audio:deviceId?{deviceId:{exact:deviceId}}:true};
navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
state.micTestStream=stream;
var audioCtx=new (window.AudioContext||window.webkitAudioContext)();
var source=audioCtx.createMediaStreamSource(stream);
var analyser=audioCtx.createAnalyser();
analyser.fftSize=256;
source.connect(analyser);
var dest=audioCtx.createMediaStreamDestination();
source.connect(dest);
var audio=new Audio();
audio.srcObject=stream;
audio.play();
state.micTestAudio=audio;
state.micTestAnalyser=analyser;
var dataArray=new Uint8Array(analyser.frequencyBinCount);
function updateLevel(){
if(!state.micTestStream)return;
analyser.getByteFrequencyData(dataArray);
var sum=0;for(var i=0;i<dataArray.length;i++)sum+=dataArray[i];
var avg=sum/dataArray.length;
var level=Math.min(100,avg*1.5);
if(bar)bar.style.width=level+'%';
state.micTestAnimFrame=requestAnimationFrame(updateLevel);
}
updateLevel();
if(btn){btn.classList.add('testing');btn.querySelector('span').textContent='Остановить';}
}).catch(function(e){console.error('Mic test error',e);alert('Не удалось получить доступ к микрофону');});
}

function stopMicTest(){
var btn=qS('#mic-test-btn');
var bar=qS('#mic-level-bar');
if(state.micTestAnimFrame)cancelAnimationFrame(state.micTestAnimFrame);
if(state.micTestAudio){state.micTestAudio.pause();state.micTestAudio.srcObject=null;state.micTestAudio=null;}
if(state.micTestStream){state.micTestStream.getTracks().forEach(function(t){t.stop();});state.micTestStream=null;}
state.micTestAnalyser=null;
if(bar)bar.style.width='0%';
if(btn){btn.classList.remove('testing');btn.querySelector('span').textContent='Проверить микрофон';}
}

function toggleMicTest(){
if(state.micTestStream)stopMicTest();
else startMicTest();
}

function initCustomSelects(){document.addEventListener('click',function(e){var trig=e.target.closest('.custom-select-trigger');var opt=e.target.closest('.custom-select-option');if(trig){e.stopPropagation();var sel=trig.closest('.custom-select');var opens=document.querySelectorAll('.custom-select.open');for(var i=0;i<opens.length;i++){if(opens[i]!==sel)opens[i].classList.remove('open');}sel.classList.toggle('open');return;}if(opt){var sel2=opt.closest('.custom-select');var opts=sel2.querySelectorAll('.custom-select-option');for(var j=0;j<opts.length;j++)opts[j].classList.remove('selected');opt.classList.add('selected');var tr=sel2.querySelector('.custom-select-trigger span');if(tr)tr.textContent=opt.textContent;var hi=sel2.parentElement.querySelector('input[type="hidden"]');if(hi)hi.value=opt.dataset.value;sel2.classList.remove('open');return;}var allOpen=document.querySelectorAll('.custom-select.open');for(var k=0;k<allOpen.length;k++)allOpen[k].classList.remove('open');});}

function init(){
console.log('Init started');
var minBtn=qS('#minimize-btn');var maxBtn=qS('#maximize-btn');var clsBtn=qS('#close-btn');
if(minBtn)minBtn.onclick=function(){if(window.electronAPI)window.electronAPI.minimize();};
if(maxBtn)maxBtn.onclick=function(){if(window.electronAPI)window.electronAPI.maximize();};
if(clsBtn)clsBtn.onclick=function(){if(window.electronAPI)window.electronAPI.close();};
var showReg=qS('#show-register');var showLog=qS('#show-login');var logBox=qS('#login-box');var regBox=qS('#register-box');
if(showReg)showReg.onclick=function(e){e.preventDefault();if(logBox)logBox.classList.add('hidden');if(regBox)regBox.classList.remove('hidden');};
if(showLog)showLog.onclick=function(e){e.preventDefault();if(regBox)regBox.classList.add('hidden');if(logBox)logBox.classList.remove('hidden');};
var slp=qS('#show-login-pass');var srp=qS('#show-reg-pass');
if(slp)slp.onclick=function(){var i=qS('#login-pass');if(i){i.type=i.type==='password'?'text':'password';slp.textContent=i.type==='password'?'Показать':'Скрыть';}};
if(srp)srp.onclick=function(){var i=qS('#reg-pass');if(i){i.type=i.type==='password'?'text':'password';srp.textContent=i.type==='password'?'Показать':'Скрыть';}};
var logBtn=qS('#login-btn');
if(logBtn){logBtn.onclick=function(){console.log('Login clicked');var em=qS('#login-email');var pw=qS('#login-pass');var er=qS('#login-error');var emv=em?em.value.trim():'';var pwv=pw?pw.value:'';if(!emv||!pwv){if(er)er.textContent='Заполните все поля';return;}localStorage.setItem('lastEmail',emv);localStorage.setItem('lastPwd',pwv);if(!send({type:'login',email:emv,password:pwv})){if(er)er.textContent='Нет подключения';}};}
var regBtn=qS('#reg-btn');
if(regBtn){regBtn.onclick=function(){var nm=qS('#reg-name');var em=qS('#reg-email');var pw=qS('#reg-pass');var er=qS('#reg-error');var nmv=nm?nm.value.trim():'';var emv=em?em.value.trim():'';var pwv=pw?pw.value:'';if(!nmv||!emv||!pwv){if(er)er.textContent='Заполните все поля';return;}if(!send({type:'register',name:nmv,email:emv,password:pwv})){if(er)er.textContent='Нет подключения';}};}
var le=qS('#login-email');var lp=qS('#login-pass');
if(le)le.onkeypress=function(e){if(e.key==='Enter'&&lp)lp.focus();};
if(lp)lp.onkeypress=function(e){if(e.key==='Enter'&&logBtn)logBtn.click();};
var homeBtn=qS('.home-btn');
if(homeBtn){homeBtn.onclick=function(){state.currentServer=null;state.currentChannel=null;state.currentDM=null;var btns=qSA('.server-btn');for(var i=0;i<btns.length;i++)btns[i].classList.remove('active');homeBtn.classList.add('active');var svs=qSA('.sidebar-view');for(var j=0;j<svs.length;j++)svs[j].classList.remove('active');var hv=qS('#home-view');var mp=qS('#members-panel');if(hv)hv.classList.add('active');if(mp)mp.classList.remove('visible');showView('friends-view');};}
var tabs=qSA('.tab');for(var i=0;i<tabs.length;i++){(function(tab){tab.onclick=function(){var ts=qSA('.tab');for(var j=0;j<ts.length;j++)ts[j].classList.remove('active');tab.classList.add('active');var tcs=qSA('.tab-content');for(var k=0;k<tcs.length;k++)tcs[k].classList.remove('active');var tc=document.getElementById('tab-'+tab.dataset.tab);if(tc)tc.classList.add('active');};})(tabs[i]);}
var searchBtn=qS('#search-btn');if(searchBtn){searchBtn.onclick=function(){var inp=qS('#search-input');var n=inp?inp.value.trim():'';if(n)send({type:'friend_request',name:n});};}
console.log('Init part 1 done');
initPart2();
}

function initPart2(){
var addSrvBtn=qS('#add-server-btn');
if(addSrvBtn){addSrvBtn.onclick=function(){state.newServerIcon=null;var ic=qS('#new-server-icon');if(ic){ic.classList.remove('has-image');ic.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';}var ni=qS('#new-server-name');if(ni)ni.value='';openModal('create-server-modal');};}
var upSrvIc=qS('#upload-server-icon');var newSrvIc=qS('#new-server-icon');var srvIcInp=qS('#server-icon-input');
if(upSrvIc)upSrvIc.onclick=function(){if(srvIcInp)srvIcInp.click();};
if(newSrvIc)newSrvIc.onclick=function(){if(srvIcInp)srvIcInp.click();};
if(srvIcInp){srvIcInp.onchange=function(e){var f=e.target.files?e.target.files[0]:null;if(!f||f.type.indexOf('image')<0)return;var r=new FileReader();r.onload=function(ev){var img=new Image();img.onload=function(){var cv=document.createElement('canvas');cv.width=cv.height=128;var ctx=cv.getContext('2d');var min=Math.min(img.width,img.height);ctx.drawImage(img,(img.width-min)/2,(img.height-min)/2,min,min,0,0,128,128);state.newServerIcon=cv.toDataURL('image/png');var ic=qS('#new-server-icon');if(ic){ic.innerHTML='<img src="'+state.newServerIcon+'">';ic.classList.add('has-image');}};img.src=ev.target.result;};r.readAsDataURL(f);};}
var createSrvBtn=qS('#create-server-btn');if(createSrvBtn){createSrvBtn.onclick=function(){var ni=qS('#new-server-name');var n=ni?ni.value.trim():'';if(n){send({type:'create_server',name:n,icon:state.newServerIcon||null});closeModal('create-server-modal');state.newServerIcon=null;}};}
var joinSrvBtn=qS('#join-server-btn');if(joinSrvBtn)joinSrvBtn.onclick=function(){openModal('join-modal');};
var useInvBtn=qS('#use-invite-btn');if(useInvBtn){useInvBtn.onclick=function(){var ic=qS('#invite-code');var c=ic?ic.value.trim():'';if(c){send({type:'use_invite',code:c});closeModal('join-modal');}};}
var addChBtn=qS('#add-channel-btn');var addVcBtn=qS('#add-voice-btn');
if(addChBtn)addChBtn.onclick=function(){state.creatingVoice=false;openModal('channel-modal');};
if(addVcBtn)addVcBtn.onclick=function(){state.creatingVoice=true;openModal('channel-modal');};
var createChBtn=qS('#create-channel-btn');if(createChBtn){createChBtn.onclick=function(){var ni=qS('#new-channel-name');var n=ni?ni.value.trim():'';if(n&&state.currentServer){send({type:'create_channel',serverId:state.currentServer,name:n,isVoice:state.creatingVoice});closeModal('channel-modal');}};}
function sendMsg(){var inp=state.currentDM?qS('#dm-input'):qS('#msg-input');var t=inp?inp.value.trim():'';if(!t)return;if(state.currentDM){send({type:'dm',to:state.currentDM,text:t});}else if(state.currentChannel){var msgData={type:'message',serverId:state.currentServer,channel:state.currentChannel,text:t};if(state.replyingTo){msgData.replyTo={id:state.replyingTo.id,author:state.replyingTo.author,text:state.replyingTo.text,avatar:state.replyingTo.avatar||null};}var localMsg={id:'temp_'+Date.now(),oderId:state.userId,author:state.username,avatar:state.userAvatar,text:t,time:Date.now(),replyTo:msgData.replyTo||null,pending:true};appendMessage(localMsg);send(msgData);hideReplyBar();}if(inp)inp.value='';}
var sendBtn=qS('#send-btn');var dmSendBtn=qS('#dm-send-btn');var msgInp=qS('#msg-input');var dmInp=qS('#dm-input');
if(sendBtn)sendBtn.onclick=sendMsg;
if(dmSendBtn)dmSendBtn.onclick=sendMsg;
if(msgInp)msgInp.onkeypress=function(e){if(e.key==='Enter')sendMsg();};
if(dmInp)dmInp.onkeypress=function(e){if(e.key==='Enter')sendMsg();};
var replyCloseBtn=qS('#reply-close');if(replyCloseBtn)replyCloseBtn.onclick=hideReplyBar;
var vcLeave=qS('#voice-leave');var vcMic=qS('#voice-mic');
if(vcLeave)vcLeave.onclick=leaveVoiceChannel;
if(vcMic){vcMic.onclick=function(){if(state.localStream){var tr=state.localStream.getAudioTracks()[0];if(tr){tr.enabled=!tr.enabled;vcMic.classList.toggle('active',tr.enabled);}}};}
console.log('Init part 2 done');
initPart3();
}

function initPart3(){
var setBtn=qS('#settings-btn');
if(setBtn){setBtn.onclick=function(){var ni=qS('#settings-name');if(ni)ni.value=state.username||'';var av=qS('#settings-avatar');if(av){if(state.userAvatar)av.innerHTML='<img src="'+state.userAvatar+'">';else{av.innerHTML='';av.textContent=state.username?state.username.charAt(0).toUpperCase():'?';}}openModal('settings-modal');};}
var setTabs=qSA('.settings-tab');for(var i=0;i<setTabs.length;i++){(function(tab){tab.onclick=function(){var ts=qSA('.settings-tab');for(var j=0;j<ts.length;j++)ts[j].classList.remove('active');tab.classList.add('active');var ps=qSA('.settings-panel');for(var k=0;k<ps.length;k++)ps[k].classList.remove('active');var p=document.getElementById('settings-'+tab.dataset.settings);if(p)p.classList.add('active');};})(setTabs[i]);}
var themeBtns=qSA('.theme-btn');for(var j=0;j<themeBtns.length;j++){(function(b){b.onclick=function(){applyTheme(b.dataset.theme);};})(themeBtns[j]);}
var avInp=qS('#avatar-input');var upAv=qS('#upload-avatar');var setAv=qS('#settings-avatar');
if(upAv)upAv.onclick=function(){if(avInp)avInp.click();};
if(setAv)setAv.onclick=function(){if(avInp)avInp.click();};
if(avInp){avInp.onchange=function(){var f=this.files?this.files[0]:null;if(!f)return;var r=new FileReader();r.onload=function(e){var img=new Image();img.onload=function(){var cv=document.createElement('canvas');cv.width=cv.height=128;var ctx=cv.getContext('2d');var sz=Math.min(img.width,img.height);ctx.drawImage(img,(img.width-sz)/2,(img.height-sz)/2,sz,sz,0,0,128,128);state.userAvatar=cv.toDataURL('image/png');var av=qS('#settings-avatar');if(av)av.innerHTML='<img src="'+state.userAvatar+'">';};img.src=e.target.result;};r.readAsDataURL(f);};}
var rmAv=qS('#remove-avatar');if(rmAv){rmAv.onclick=function(){state.userAvatar=null;var av=qS('#settings-avatar');if(av){av.innerHTML='';av.textContent=state.username?state.username.charAt(0).toUpperCase():'?';}};}
var savePrf=qS('#save-profile');if(savePrf){savePrf.onclick=function(){var ni=qS('#settings-name');var n=ni?ni.value.trim():'';if(n)send({type:'update_profile',name:n,avatar:state.userAvatar});};}
var micTestBtn=qS('#mic-test-btn');if(micTestBtn){micTestBtn.onclick=toggleMicTest;}
var srvCtx=qS('#server-context');
var invAct=srvCtx?srvCtx.querySelector('[data-action="invite"]'):null;
var setAct=srvCtx?srvCtx.querySelector('[data-action="settings"]'):null;
var leaveAct=srvCtx?srvCtx.querySelector('[data-action="leave"]'):null;
if(invAct){invAct.onclick=function(){var sid=srvCtx.dataset.serverId;if(sid)send({type:'create_invite',serverId:sid});hideContextMenu();};}
if(setAct){setAct.onclick=function(){var sid=srvCtx.dataset.serverId;var srv=state.servers.get(sid);if(!srv)return;if(srv.ownerId!==state.userId){alert('Только владелец');hideContextMenu();return;}var ni=qS('#edit-server-name');if(ni)ni.value=srv.name;var ic=qS('#edit-server-icon');if(ic){if(srv.icon){ic.innerHTML='<img src="'+srv.icon+'">';ic.classList.add('has-image');}else{ic.innerHTML='<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>';ic.classList.remove('has-image');}}state.editingServerId=sid;state.editServerIcon=srv.icon||null;send({type:'get_server_members',serverId:sid});openModal('server-settings-modal');hideContextMenu();};}
if(leaveAct){leaveAct.onclick=function(){var sid=srvCtx.dataset.serverId;var srv=state.servers.get(sid);if(!srv)return;if(srv.ownerId===state.userId){alert('Владелец не может покинуть');hideContextMenu();return;}if(confirm('Покинуть "'+srv.name+'"?'))send({type:'leave_server',serverId:sid});hideContextMenu();};}
console.log('Init part 3 done');
initPart4();
}

function initPart4(){
var chCtx=qS('#channel-context');
var editChAct=chCtx?chCtx.querySelector('[data-action="edit-channel"]'):null;
var cloneChAct=chCtx?chCtx.querySelector('[data-action="clone-channel"]'):null;
var deleteChAct=chCtx?chCtx.querySelector('[data-action="delete-channel"]'):null;
if(editChAct){editChAct.onclick=function(){var cid=chCtx.dataset.channelId;var isVoice=chCtx.dataset.isVoice==='1';var srv=state.servers.get(state.currentServer);if(!srv||srv.ownerId!==state.userId){alert('Только владелец');hideContextMenu();return;}var channels=isVoice?srv.voiceChannels:srv.channels;var ch=null;for(var i=0;i<channels.length;i++){if(channels[i].id===cid){ch=channels[i];break;}}if(ch){state.editingChannelId=cid;state.editingChannelIsVoice=isVoice;var ecn=qS('#edit-channel-name');var ect=qS('#edit-channel-topic');if(ecn)ecn.value=ch.name||'';if(ect)ect.value=ch.topic||'';openModal('edit-channel-modal');}hideContextMenu();};}
if(cloneChAct){cloneChAct.onclick=function(){var cid=chCtx.dataset.channelId;var isVoice=chCtx.dataset.isVoice==='1';var srv=state.servers.get(state.currentServer);if(!srv||srv.ownerId!==state.userId){alert('Только владелец');hideContextMenu();return;}var channels=isVoice?srv.voiceChannels:srv.channels;var ch=null;for(var i=0;i<channels.length;i++){if(channels[i].id===cid){ch=channels[i];break;}}if(ch){send({type:'create_channel',serverId:state.currentServer,name:ch.name+'-копия',isVoice:isVoice});}hideContextMenu();};}
if(deleteChAct){deleteChAct.onclick=function(){var cid=chCtx.dataset.channelId;var isVoice=chCtx.dataset.isVoice==='1';var srv=state.servers.get(state.currentServer);if(!srv||srv.ownerId!==state.userId){alert('Только владелец');hideContextMenu();return;}var channels=isVoice?srv.voiceChannels:srv.channels;var ch=null;for(var i=0;i<channels.length;i++){if(channels[i].id===cid){ch=channels[i];break;}}if(ch){console.log('Setting delete channel:',cid,'isVoice:',isVoice);state.deletingChannelId=cid;state.deletingChannelIsVoice=isVoice;var dcn=qS('#delete-channel-name');if(dcn)dcn.textContent='"'+ch.name+'"';openModal('confirm-delete-channel-modal');}hideContextMenu();};}
var catCtx=qS('#category-context');
var createChCat=catCtx?catCtx.querySelector('[data-action="create-channel"]'):null;
var editCatAct=catCtx?catCtx.querySelector('[data-action="edit-category"]'):null;
if(createChCat){createChCat.onclick=function(){state.creatingVoice=catCtx.dataset.isVoice==='1';openModal('channel-modal');hideContextMenu();};}
if(editCatAct){editCatAct.onclick=function(){alert('Редактирование категории (в разработке)');hideContextMenu();};}
var catTitles=qSA('.section-title[data-category]');for(var c=0;c<catTitles.length;c++){(function(cat){cat.oncontextmenu=function(e){e.preventDefault();e.stopPropagation();showCategoryContext(e.clientX,e.clientY,cat.dataset.category==='voice');};})(catTitles[c]);}
var confDelChBtn=qS('#confirm-delete-channel-btn');if(confDelChBtn){confDelChBtn.onclick=function(){if(state.deletingChannelId&&state.currentServer){console.log('Deleting channel:',state.deletingChannelId,'isVoice:',state.deletingChannelIsVoice);send({type:'delete_channel',serverId:state.currentServer,channelId:state.deletingChannelId,isVoice:!!state.deletingChannelIsVoice});closeModal('confirm-delete-channel-modal');state.deletingChannelId=null;state.deletingChannelIsVoice=false;}};}
var chSetTabs=qSA('[data-channel-settings]');for(var ct=0;ct<chSetTabs.length;ct++){(function(tab){tab.onclick=function(){var ts=qSA('[data-channel-settings]');for(var j=0;j<ts.length;j++)ts[j].classList.remove('active');tab.classList.add('active');var ps=qSA('#edit-channel-modal .settings-panel');for(var k=0;k<ps.length;k++)ps[k].classList.remove('active');var p=document.getElementById('channel-settings-'+tab.dataset.channelSettings);if(p)p.classList.add('active');};})(chSetTabs[ct]);}
var saveChSet=qS('#save-channel-settings');if(saveChSet){saveChSet.onclick=function(){var ecn=qS('#edit-channel-name');var ect=qS('#edit-channel-topic');var name=ecn?ecn.value.trim():'';if(name&&state.editingChannelId&&state.currentServer){send({type:'update_channel',serverId:state.currentServer,channelId:state.editingChannelId,name:name,topic:ect?ect.value.trim():'',isVoice:state.editingChannelIsVoice});closeModal('edit-channel-modal');}};}
var delChFromSet=qS('#delete-channel-from-settings');if(delChFromSet){delChFromSet.onclick=function(){if(state.editingChannelId){state.deletingChannelId=state.editingChannelId;state.deletingChannelIsVoice=state.editingChannelIsVoice;var srv=state.servers.get(state.currentServer);var channels=state.editingChannelIsVoice?srv.voiceChannels:srv.channels;var ch=null;for(var i=0;i<channels.length;i++){if(channels[i].id===state.editingChannelId){ch=channels[i];break;}}var dcn=qS('#delete-channel-name');if(dcn&&ch)dcn.textContent='"'+ch.name+'"';closeModal('edit-channel-modal');openModal('confirm-delete-channel-modal');}};}
var msgCtx=qS('#message-context');
var copyTextAct=msgCtx?msgCtx.querySelector('[data-action="copy-text"]'):null;
if(copyTextAct){copyTextAct.onclick=function(){var txt=msgCtx.dataset.msgText||'';navigator.clipboard.writeText(txt).then(function(){console.log('Copied');});hideContextMenu();};}
var replyAct=msgCtx?msgCtx.querySelector('[data-action="reply"]'):null;
if(replyAct){replyAct.onclick=function(){var msgId=msgCtx.dataset.msgId;var msgText=msgCtx.dataset.msgText;var msgAuthor=msgCtx.dataset.msgAuthor||'';var msgEl=qS('.message[data-id="'+msgId+'"]');var msgAvatar=null;if(msgEl){var avEl=msgEl.querySelector('.message-body .avatar img');if(avEl)msgAvatar=avEl.src;}state.replyingTo={id:msgId,text:msgText,author:msgAuthor,avatar:msgAvatar};showReplyBar();hideContextMenu();};}
var forwardAct=msgCtx?msgCtx.querySelector('[data-action="forward"]'):null;
if(forwardAct){forwardAct.onclick=function(){var msgId=msgCtx.dataset.msgId;var msgText=msgCtx.dataset.msgText;state.forwardingMsg={id:msgId,text:msgText};openModal('forward-modal');hideContextMenu();};}
var delMsgAct=msgCtx?msgCtx.querySelector('[data-action="delete-message"]'):null;
if(delMsgAct){delMsgAct.onclick=function(){var msgId=msgCtx.dataset.msgId;console.log('Delete message clicked, msgId:',msgId,'server:',state.currentServer,'channel:',state.currentChannel);if(msgId&&state.currentServer&&state.currentChannel){send({type:'delete_message',serverId:state.currentServer,channelId:state.currentChannel,messageId:msgId});console.log('Delete message sent');}hideContextMenu();};}
var srvSetTabs=qSA('[data-server-settings]');for(var i=0;i<srvSetTabs.length;i++){(function(tab){tab.onclick=function(){var ts=qSA('[data-server-settings]');for(var j=0;j<ts.length;j++)ts[j].classList.remove('active');tab.classList.add('active');var ps=qSA('#server-settings-modal .settings-panel');for(var k=0;k<ps.length;k++)ps[k].classList.remove('active');var p=document.getElementById('server-settings-'+tab.dataset.serverSettings);if(p)p.classList.add('active');};})(srvSetTabs[i]);}
var chgSrvIc=qS('#change-server-icon');var edSrvIc=qS('#edit-server-icon');var edSrvIcInp=qS('#edit-server-icon-input');
if(chgSrvIc)chgSrvIc.onclick=function(){if(edSrvIcInp)edSrvIcInp.click();};
if(edSrvIc)edSrvIc.onclick=function(){if(edSrvIcInp)edSrvIcInp.click();};
if(edSrvIcInp){edSrvIcInp.onchange=function(e){var f=e.target.files?e.target.files[0]:null;if(!f||f.type.indexOf('image')<0)return;var r=new FileReader();r.onload=function(ev){var img=new Image();img.onload=function(){var cv=document.createElement('canvas');cv.width=cv.height=128;var ctx=cv.getContext('2d');var min=Math.min(img.width,img.height);ctx.drawImage(img,(img.width-min)/2,(img.height-min)/2,min,min,0,0,128,128);state.editServerIcon=cv.toDataURL('image/png');var ic=qS('#edit-server-icon');if(ic){ic.innerHTML='<img src="'+state.editServerIcon+'">';ic.classList.add('has-image');}};img.src=ev.target.result;};r.readAsDataURL(f);};}
var saveSrvSet=qS('#save-server-settings');if(saveSrvSet){saveSrvSet.onclick=function(){var ni=qS('#edit-server-name');var n=ni?ni.value.trim():'';if(!n||!state.editingServerId)return;send({type:'update_server',serverId:state.editingServerId,name:n,icon:state.editServerIcon});closeModal('server-settings-modal');};}
var delSrvBtn=qS('#delete-server-btn');if(delSrvBtn){delSrvBtn.onclick=function(){var srv=state.servers.get(state.editingServerId);if(!srv)return;var dsn=qS('#delete-server-name');var csn=qS('#confirm-server-name');var cdb=qS('#confirm-delete-btn');if(dsn)dsn.textContent=srv.name;if(csn)csn.value='';if(cdb)cdb.disabled=true;openModal('confirm-delete-modal');};}
var confSrvNm=qS('#confirm-server-name');if(confSrvNm){confSrvNm.oninput=function(e){var srv=state.servers.get(state.editingServerId);var cdb=qS('#confirm-delete-btn');if(cdb)cdb.disabled=e.target.value!==(srv?srv.name:'');};}
var confDelBtn=qS('#confirm-delete-btn');if(confDelBtn){confDelBtn.onclick=function(){if(!state.editingServerId)return;send({type:'delete_server',serverId:state.editingServerId});closeModal('confirm-delete-modal');closeModal('server-settings-modal');state.editingServerId=null;};}
var cpyInv=qS('#copy-invite');if(cpyInv){cpyInv.onclick=function(){var cd=qS('#invite-code-display');var c=cd?cd.value:'';if(c)navigator.clipboard.writeText(c);};}
var closeBtns=qSA('[data-close]');for(var m=0;m<closeBtns.length;m++){(function(b){b.onclick=function(){stopMicTest();var mod=b.closest('.modal');if(mod)mod.classList.remove('active');};})(closeBtns[m]);}
var modals=qSA('.modal');for(var n=0;n<modals.length;n++){(function(mod){mod.onclick=function(e){if(e.target===mod){stopMicTest();mod.classList.remove('active');}};})(modals[n]);}
document.addEventListener('click',hideContextMenu);
initCustomSelects();
connect();
setTimeout(function(){send({type:'get_friends'});},1000);
console.log('Init completed!');
}
document.addEventListener('DOMContentLoaded',init);
console.log('App.js fully loaded');
